---
created: 2023-10-27T21:08:00
updated: 2023-12-06T20:07
tags:
  - структура-таблиц
  - ms4d
---
# Структура таблиц баз данных

- [Назначение таблиц баз данных](#%D0%9D%D0%B0%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86-%D0%B1%D0%B0%D0%B7-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
- [Архив данных](#%D0%90%D1%80%D1%85%D0%B8%D0%B2-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
	- [Таблица - projects](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0---projects)
	- [Таблица - items](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0---items)
	- [Таблица - rawdata](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0---rawdata)
	- [Таблица - sys_props](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0---sys_props)
- [Архив сообщений](#%D0%90%D1%80%D1%85%D0%B8%D0%B2-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B9)
	- [Назначение таблиц баз данных](#%D0%9D%D0%B0%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86-%D0%B1%D0%B0%D0%B7-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
	- [Таблица  - events_alarms](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0----events_alarms)
	- [Таблица - events_recs](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0---events_recs)
	- [Таблица - events_alarms_field](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0---events_alarms_field)
	- [Таблица - events_recs_fields](#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0---events_recs_fields)
	- [Архив сообщений по умолчанию](#%D0%90%D1%80%D1%85%D0%B8%D0%B2-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B9-%D0%BF%D0%BE-%D1%83%D0%BC%D0%BE%D0%BB%D1%87%D0%B0%D0%BD%D0%B8%D1%8E)
- [Источники](#%D0%98%D1%81%D1%82%D0%BE%D1%87%D0%BD%D0%B8%D0%BA%D0%B8)

>[!warning] Для хранения [архива данных](#Архив%20данных) и [архива сообщений](#Архив%20сообщений) рекомендуется использовать отдельные базы данных.

>[!warning] В случае использования СУБД PostgreSQL предварительно требуется создать пустые базы данных для [архива данных](#Архив%20данных) и для [архива сообщений](#Архив%20сообщений).  

### Назначение таблиц баз данных

В обеих базах есть таблица **projects**, в которой хранится информация о проектах подключенных к БД.

|**Название**|**Назначение**|
|---|---|
|**projects**|Информация о проектах подключенных к БД|
|**items**|Информация об архивируемых параметрах|
|**raw_data**|Непосредственно таблица с архивными данными|
|**sys_props**|Служебная таблица, хранит версию структуры БД и другие служебные свойства|

>[!info] Таблицы создаются автоматически при первом запуске исполнительной системы.

При изменении списка архивируемых параметров таблицы будут дописываться. Уже существующие записи удаляться не будут, за исключением случаев, которые указаны в настройках проекта.

## Архив данных

### Таблица - projects

|**Название**|**Назначение**|
|---|---|
|**id**|Первичный ключ|
|**name**|Имя проекта|
|**guid**|Уникальный GUID проекта|

### Таблица - items

|**Название**|**Назначение**|
|---|---|
|**id**|Первичный ключ|
|**project_id**|Внешний ключ для связи с таблицей **projects**|
|**itemid**|ID параметра в проекте. Формируется автоматически и указывается в  <br>соответствующем свойстве **категории Служебные**|
|**path**|Путь к полю параметра или к параметру внутри **экземпляра объекта**|
|**name**|Полное иерархическое имя параметра в проекте|
|**first_time**|Время первого значения (FILETIME)|
|**last_time**|Время последнего значения (FILETIME)|
|**count**|Показывает число записей в базе|
|**type**|OpcUa код типа значения параметра|

### Таблица - rawdata

|**Название**|**Назначение**|
|---|---|
|**layer**|ID слоя данных:<br>**0** - базовый слой<br>**1** - минутный слой<br>**2** - часовой слой|
|**archive_itemid**|Внешний ключ для связи с таблицей **item**|
|**source_time**|Время формирования значения (**FILETIME**)|
|**server_time**|Время сервера, в настоящее время не используется (**FILETIME**)|
|**status_code**|OpcUa код статуса данных|
|**value**|Значение числовых данных (**double**). В SQLite3 хранит все возможные  <br>типы данных|
|**s_value**|Данные типа string. Отсутствует в SQLite3|

### Таблица - sys_props

|**Название**|**Назначение**|
|---|---|
|**name**|Имя параметра|
|**value**|Значение параметра|

## Архив сообщений

>[!info] Все сообщения, возникающие в среде исполнения, автоматически попадают в архив.

Архивирование сообщений поддерживается на всех ОС.

Для хранения архивов могут быть использованы следующие базы данных:
- SQLITE;
- POSTGRESQL;
- MS SQL.

Настройки архивирования сообщений задаются в панели свойств элемента **Основной архив сообщений**.

При архивировании сообщений в архив записывается новая строка при каждом изменении состояния сообщения:
- Появление;
- Квитирование;
- Исчезновение.

![](_файлы/Pasted%20image%2020231205224935.png)

### Назначение таблиц баз данных

|**Название**|**Назначение**|
|---|---|
|**projects**|Информация о проектах подключенных к БД|
|**events_alarms**|Информация о всех типах сообщений в проекте|
|**events_recs**|Архив сообщений|
|**events_alarms_fields**|Дополнительные поля сообщений (добавляемые пользователем в проекте у тревог или ФБ FireBaseEvent)|
|**events_recs_fields**|Значения дополнительных полей сообщений (добавляемые пользователем в проекте)|

### Таблица  - events_alarms

|**Название**|**Назначение**|
|---|---|
|**id**|Первичный ключ|
|**project_id**|Внешний ключ для связи с таблицей **projects**|
|**itemid**|ID параметра источника сообщения в проекте. Формируется автоматически и указывается в соответствующем свойстве категории **Служебные**<br>- для тревог - ID тревоги<br>- для сообщений от шкалы параметра - Id параметра<br>- для сообщений, выданных из ФБ - ID ФБ<br>- для сообщений безопасности и контроля целостности - ID элемента Безопасность<br>- для сообщений о действиях пользователя - ID элемента, с которым совершается определенное действие|
|**path**|Путь к источнику сообщения внутри экземпляра объекта|
|**name**|Полное иерархическое имя источника сообщения в проекте|
|**type_id**|Подтип сообщения. Возможные варианты:<br>**0** - тревоги;<br>- для сообщений от шкалы параметра определяется типом уставки:<br>**1** - HiHi,<br>**2** - Hi,<br>**3** - Lo,<br>**4** - LoLo,<br>**5** - RateOfChange.<br>- при выдаче сообщения через **FireBaseEvent** определяется входом **EventTypeId**.<br>- для **системных сообщений** и **сообщений безопасности** определяется типом сообщения. Старшие 16 бит определяют категорию:<br>**1** - сообщения о действиях пользователя,<br>**2** - сообщения об операциях изменения параметров безопасности, изменения списка пользователей (настроек и паролей), сообщения ошибки защиты или контроля целостности,<br>**3** - системные сообщения.|

### Таблица - events_recs

|**Название**|**Назначение**|
|---|---|
|**id**|Первичный ключ|
|**alarm_id**|Внешний ключ для связи с таблицей **events_alarms**|
|**time**|Время последнего изменения состояния сообщения. Тип FILETIME|
|**update_type**|Тип изменения:<br>**1** - Активирована,<br>**2** - Деактивирована (для условных сообщений),<br>**3** - Квитировано.|
|**active_time**|Время активации сообщения. Тип FILETIME|
|**in_active_time**|Время деактивации сообщения. Тип FILETIME|
|**acked_time**|Время квитирования сообщения. Тип FILETIME|
|**acked**|Состояние квитирования сообщения. Тип BOOL|
|**active**|Состояние активности сообщения. Тип BOOL|
|**severity**|Приоритет сообщения|
|**message**|Текст сообщения|
|**comment**|Комментарий оператора, заданный при квитировании сообщения (также может быть задан параметром при генерации сообщения с использованием тревоги или ФБ)|
|**user_address**|**IP** адрес узла, на котором был открыт клиент визуализации, в котором квитировали сообщение|
|**user_name**|Имя пользователя, который квитировал сообщение|

### Таблица - events_alarms_field

|**Название**|**Назначение**|
|---|---|
|**id**|Первичный ключ|
|**name**|Имя дополнительного параметра сообщения|

### Таблица - events_recs_fields

|**Название**|**Назначение**|
|---|---|
|**event_rec_id**|Внешний ключ для связи с таблицей **events_recs**|
|**field_id**|Внешний ключ для связи с таблицей **events_alarms_fields**|
|**value**|Значение параметра|

### Архив сообщений по умолчанию

По умолчанию архив сообщений хранится в базе данных **SQLite**. Файл базы данных носит название **EventsData.db**.

Если проект запускается в среде исполнения, входящей в состав среды разработки, то архив будет хранится в папке:
*<профиль пользователя>\AppData\Roaming\MPSSot\<продукт>\Debug_<имя проекта>\<имя узла>\PLC\EventsData.db*.

В среде исполнения, установленной независимо от среды разработки, файл архива будет храниться в папке:
*c:\Users\<имя пользователя>\AppData\Roaming\MPSSot\MasterSCADA4DRT1.2\Server\EventsData.db*

Архив сообщений на других ОС хранится внутри папки **mplc**.

## Источники

- Информация предоставлена специалистами MasterScada.  
- [https://support.mps-soft.ru/Site/MasterSCADA 4D/User Guide MasterSCADA 4D.pdf](https://support.mps-soft.ru/Site/MasterSCADA%204D/User%20Guide%20MasterSCADA%204D.pdf)